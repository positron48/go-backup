# Backup Tool

Система автоматизации бэкапов на Go.

## Сборка

### Локальная сборка

```bash
go build -o backup-tool .
```

### Автоматическая сборка через GitHub Actions

При создании тега (например, `v1.0.0`) или через workflow_dispatch автоматически собирается бинарник для Ubuntu 20.04 и прикрепляется к релизу.

```bash
# Создание тега и пуш
git tag v1.0.0
git push origin v1.0.0
```

## Использование

```bash
./backup-tool [config.yaml]
```

Если путь к конфигу не указан, используется `config.yaml` в текущей директории.


## Конфигурация

Утилита использует YAML-конфигурационный файл для настройки бэкапов. Пример конфигурации находится в файле `config-example.yaml`.

### Структура конфигурации

#### Глобальные настройки (`global`)

- `backup_dir` - папка для хранения всех бэкапов (обязательно)
- `retention` - глобальная политика хранения бэкапов:
  - `daily` - количество дневных бэкапов
  - `weekly` - количество недельных бэкапов
  - `monthly` - количество месячных бэкапов
  - `yearly` - количество годовых бэкапов
- `filename_mask` - маска для именования файлов (обязательно)
  - Доступные переменные: `%name%`, `%Y%`, `%m%`, `%d%`, `%H%`, `%M%`, `%S%`
  - Пример: `%name%-%Y%m%d%H%M%S` → `backup-20241214153045`
- `default_compression` - сжатие по умолчанию: `gzip`, `zip`, `tar`, `tar.gz`, `none`
- `pre_hooks` - список команд для выполнения перед всеми бэкапами (опционально)
- `post_hooks` - список команд для выполнения после всех бэкапов (опционально)
- `include_dir` - папка с подключаемыми конфигами бэкапов (опционально)
  - Утилита автоматически читает все `.yaml` и `.yml` файлы из этой папки
  - Каждый файл должен содержать один бэкап (без обертки в массив)

#### Настройки бэкапа (`backups`)

Каждый бэкап может быть настроен двумя способами:

1. **Бэкап директории** - использует `source_dir`:
   - `name` - имя бэкапа (обязательно)
   - `subdirectory` - подпапка в `backup_dir` (обязательно)
   - `source_dir` - путь к директории для бэкапа
   - `exclude_patterns` - список glob-паттернов для исключения файлов/папок (опционально)
   - `compression` - тип сжатия (переопределяет `default_compression`, опционально)
   - `retention` - политика хранения (переопределяет глобальную, опционально)

2. **Бэкап через команду** - использует `command` и `output_file`:
   - `name` - имя бэкапа (обязательно)
   - `subdirectory` - подпапка в `backup_dir` (обязательно)
   - `command` - команда для выполнения (например, `mysqldump`, `pg_dump`)
   - `output_file` - имя выходного файла
   - `compression` - тип сжатия (переопределяет `default_compression`, опционально)
   - `retention` - политика хранения (переопределяет глобальную, опционально)

### Примеры

См. файл `config-example.yaml` для подробных примеров использования всех возможностей утилиты.


## Функции

- Поддержка бэкапов директорий с исключениями
- Поддержка бэкапов через выполнение команд (например, дампы БД)
- Различные типы сжатия: gzip, zip, tar, tar.gz, none
- Retention policy по якорным точкам (daily, weekly, monthly, yearly)
- Pre/post hooks для выполнения команд до и после бэкапа
- Автоматическое чтение конфигов из include_dir

## Структура проекта

```
backup-tool/
├── main.go                 # Точка входа
├── config/                 # Парсинг конфигурации
├── backup/                 # Логика выполнения бэкапов
├── compression/            # Поддержка сжатия
├── retention/              # Retention policy
├── hooks/                  # Выполнение хуков
└── utils/                  # Утилиты
